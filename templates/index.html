<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Leads</title>
  <!-- Agregar Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 90vh;
      background-image: url('https://images.unsplash.com/photo-1444837881208-4d46d5c1f127?fm=jpg&q=60&w=3000&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8Ym9zcXVlJTIwYmxhbmNvJTIweSUyMG5lZ3JvfGVufDB8fDB8fHww');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    .card {
      background-color: rgba(255, 255, 255, 0.4);
      padding: 20px;
      border-radius: 10px;
    }
  </style>
</head>

<body>
  <div class="container mt-5">
    <div class="card">
      <div class="header text-center mt-2">
        <h2><b>REGISTRO DE NUEVO LEAD</b></h2>
      </div>
      <div class="card-body">
        <form id="leadForm">
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="contactName" class="form-label">Nombre del Contacto</label>
              <input type="text" class="form-control" id="contactName" required>
            </div>
            <div class="col-md-6">
              <label for="personTypeSelect" class="form-label">Buyer Persona</label>
              <select class="form-select" id="personTypeSelect" required>
                <option value="">Seleccione un tipo</option>
                <!-- Opciones cargadas dinámicamente -->
              </select>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="contactPhone" class="form-label">Número de Teléfono</label>
              <input type="text" class="form-control" id="contactPhone" required>
            </div>
            <div class="col-md-6">
              <label for="contactEmail" class="form-label">Correo Electrónico (Opcional)</label>
              <input type="email" class="form-control" id="contactEmail">
            </div>
          </div>
          <hr>
          <div class="row mb-3">
            <div class="col-md-12">
              <label for="registrarName" class="form-label">Nombre del Promotor</label>
              <input type="text" class="form-control" id="registrarName" required>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="shiftSelect" class="form-label">Bloque de Trabajo</label>
              <select class="form-select" id="shiftSelect" required>
                <option value="">Seleccione un turno</option>
                <!-- Opciones cargadas dinámicamente -->
              </select>
            </div>

            <div class="col-md-6">
              <label for="locationSelect" class="form-label">Orbpoint</label>
              <select class="form-select" id="locationSelect" required>
                <option value="">Seleccione un orbpoint</option>
                <!-- Opciones cargadas dinámicamente -->
              </select>
            </div>

          </div>

          <div class="text-center mt-4">
            <button type="submit" class="btn btn-dark"><b>ENVIAR LEAD</b></button>
          </div>
        </form>

        <div id="responseMessage" class="mt-3 text-center"></div>
      </div>
    </div>
  </div>


  <script>
    $(document).ready(function () {
      // Función para mostrar datos de depuración
      /*function displayDebugData(title, data) {
        let currentContent = $('#apiDataDisplay').html();
        $('#apiDataDisplay').html(currentContent + `<strong>${title}:</strong>\n${JSON.stringify(data, null, 2)}\n\n`);
      }*/

      // Función para obtener y cargar las opciones de los campos select
      function loadSelectOptions() {
        // Cargar opciones de Localidad
        $.get("/get_location_options", function (data) {
          //displayDebugData('Datos de localidades recibidos', data);

          let locationSelect = $('#locationSelect');
          locationSelect.find('option:not(:first)').remove(); // Mantener solo la primera opción

          if (data.locations && data.locations.length > 0) {
            // Verifica si es un array de objetos con id/value o solo array de ids
            if (typeof data.locations[0] === 'object' && data.locations[0].hasOwnProperty('id')) {
              // Formato correcto {id: xxx, value: xxx}
              data.locations.forEach(function (location) {
                locationSelect.append(`<option value="${location.id}">${location.value}</option>`);
              });
            } else {
              // Solo IDs, usar ID como texto también
              data.locations.forEach(function (locationId) {
                locationSelect.append(`<option value="${locationId}">ID: ${locationId}</option>`);
              });
            }
          }
        }).fail(function (xhr, status, error) {
          //displayDebugData('Error al cargar localidades', { status: status, error: error });
        });

        // Cargar opciones de Turnos
        $.get("/get_shift_options", function (data) {
          //displayDebugData('Datos de turnos recibidos', data);

          let shiftSelect = $('#shiftSelect');
          shiftSelect.find('option:not(:first)').remove(); // Mantener solo la primera opción

          if (data.shifts && data.shifts.length > 0) {
            // Verifica si es un array de objetos con id/value o solo array de ids
            if (typeof data.shifts[0] === 'object' && data.shifts[0].hasOwnProperty('id')) {
              // Formato correcto {id: xxx, value: xxx}
              data.shifts.forEach(function (shift) {
                shiftSelect.append(`<option value="${shift.id}">${shift.value}</option>`);
              });
            } else {
              // Solo IDs, usar ID como texto también
              data.shifts.forEach(function (shiftId) {
                shiftSelect.append(`<option value="${shiftId}">ID: ${shiftId}</option>`);
              });
            }
          }
        }).fail(function (xhr, status, error) {
          //displayDebugData('Error al cargar turnos', { status: status, error: error });
        });

        // Cargar opciones de Tipo de Persona
        $.get("/get_person_type_options", function (data) {
          //displayDebugData('Datos de tipos de persona recibidos', data);

          let personTypeSelect = $('#personTypeSelect');
          personTypeSelect.find('option:not(:first)').remove(); // Mantener solo la primera opción

          if (data.person_types && data.person_types.length > 0) {
            // Verifica si es un array de objetos con id/value o solo array de ids
            if (typeof data.person_types[0] === 'object' && data.person_types[0].hasOwnProperty('id')) {
              // Formato correcto {id: xxx, value: xxx}
              data.person_types.forEach(function (personType) {
                personTypeSelect.append(`<option value="${personType.id}">${personType.value}</option>`);
              });
            } else {
              // Solo IDs, usar ID como texto también
              data.person_types.forEach(function (personTypeId) {
                personTypeSelect.append(`<option value="${personTypeId}">ID: ${personTypeId}</option>`);
              });
            }
          }
        }).fail(function (xhr, status, error) {
          //displayDebugData('Error al cargar tipos de persona', { status: status, error: error });
        });
      }

      // Cargar opciones al cargar la página
      loadSelectOptions();

      // Enviar el formulario
      $('#leadForm').on('submit', function (e) {
        e.preventDefault();

        // Validar que se hayan seleccionado opciones
        if (!$('#locationSelect').val() || !$('#shiftSelect').val() || !$('#personTypeSelect').val()) {
          $('#responseMessage').html('<div class="alert alert-warning">Por favor seleccione todas las opciones requeridas.</div>');
          return;
        }

        let currentDate = new Date();

        // Formatear la fecha en formato 'YYYY-MM-DD'
        let creationDate = currentDate.getFullYear() + '-'
          + String(currentDate.getMonth() + 1).padStart(2, '0') + '-'
          + String(currentDate.getDate()).padStart(2, '0');

        console.log(creationDate);
        // Crear objeto Date con la fecha y hora ficticia 00:00:00
        let dateObject = new Date(creationDate + "T00:00:00Z");  // Usamos Z para UTC

        // Formatear la fecha en formato Y-m-d\TH:i:s+00:00
        let isoFormattedDate = dateObject.toISOString().slice(0, 19) + "+00:00"; // Cortar la parte de milisegundos y agregar la zona horaria


        let leadData = {
          contact_name: $('#contactName').val(),
          contact_phone: $('#contactPhone').val(),
          location_id: $('#locationSelect').val(),
          registrar_name: $('#registrarName').val(),
          shift_id: $('#shiftSelect').val(),
          person_type_id: $('#personTypeSelect').val(),
          contact_email: $('#contactEmail').val(),
          creation_date: isoFormattedDate
        };

        //displayDebugData('Datos a enviar', leadData);

        // Mostrar mensaje de carga
        $('#responseMessage').html('<div class="alert alert-info">Enviando datos, por favor espere...</div>');

        // Enviar la solicitud
        $.ajax({
          url: "/submit_lead",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify(leadData),
          success: function (response) {
            //displayDebugData('Respuesta exitosa', response);
            if (response.success) {
              $('#responseMessage').html('<div class="alert alert-success">Lead registrado correctamente.</div>');
              // Limpiar el formulario después de un registro exitoso
              $('#leadForm')[0].reset();
            } else {
              $('#responseMessage').html(`<div class="alert alert-danger">Error al registrar el lead: ${response.message}</div>`);
            }
          },
          error: function (xhr, status, error) {
            try {
              let errorObj = JSON.parse(xhr.responseText);
              //displayDebugData('Respuesta de error', errorObj);
              $('#responseMessage').html(`<div class="alert alert-danger">Error al registrar el lead: ${errorObj.message}</div>`);
            } catch (e) {
              //displayDebugData('Error al procesar respuesta', { status: status, error: error, responseText: xhr.responseText });
              $('#responseMessage').html('<div class="alert alert-danger">Error al registrar el lead. Revise la información de depuración.</div>');
            }
          }
        });
      });
    });
  </script>
</body>

</html>